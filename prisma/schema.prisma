// Prisma schema aligned with MySQL backend
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

/// Role options that control access across the app
enum Role {
  student
  teacher
}

enum SubjectLevel {
  P1
  P2
  P3
  P4
  P5
  P6
  M1
  M2
  M3
  M4
  M5
  M6
  U1
  U2
  U3
  U4
  U5
  U6
  UNSPECIFIED
}

enum StudentExamStatus {
  ASSIGNED
  IN_PROGRESS
  COMPLETED
}

model User {
  /// Primary identifier for an account
  id           String     @id @default(cuid())
  /// Display name for UI
  name         String?
  /// Unique email for login
  email        String     @unique
  /// Hashed password for credentials auth
  passwordHash String
  /// Role determines protected areas
  role         Role       @default(student)
  createdAt    DateTime   @default(now())

  questions    Question[] @relation("UserQuestions")
  exams        Exam[]     @relation("UserExams")
  attempts     ExamAttempt[]
  subjectsCreated Subject[]  @relation("TeacherSubjects")
  enrollments  SubjectEnrollment[] @relation("StudentEnrollments")
  assignmentsAssigned ExamAssignment[] @relation("AssignmentTeacher")
  studentExams StudentExam[] @relation("StudentAssignments")
}

model Question {
  /// Primary identifier for question bank entries
  id           String     @id @default(cuid())
  /// Subject grouping (e.g., Math, Science)
  subject      String
  /// Target grade level or band
  gradeLevel   String
  /// Problem statement text
  body         String
  /// Rationale or explanation
  explanation  String
  /// Marks question for AI rescoring pipeline
  shouldRescore Boolean   @default(false)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @default(now()) @updatedAt

  createdById  String
  createdBy    User       @relation("UserQuestions", fields: [createdById], references: [id])
  choices      Choice[]
  aiScores     AiScore[]
  attemptLinks AttemptAnswer[]
  currentExamAttempts ExamAttempt[] @relation("CurrentQuestion")
}

model Choice {
  /// Primary identifier for multiple-choice options
  id         String   @id @default(cuid())
  text       String
  /// Indicates the correct answer
  isCorrect  Boolean  @default(false)
  /// Maintains consistent ordering in UI
  order      Int      @default(0)

  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  answers    AttemptAnswer[]
}

model AiScore {
  /// Primary identifier for AI evaluation records
  id         String   @id @default(cuid())
  /// Difficulty score 1 (easy) through 5 (hard)
  difficulty Int
  /// Model reasoning summary
  reason     String   @db.Text
  /// Name of the AI model used
  modelName  String
  createdAt  DateTime @default(now())

  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model Exam {
  /// Primary identifier for exam sessions
  id          String       @id @default(cuid())
  title       String
  subjectId   String
  subjectRef  Subject      @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  /// Toggle for adaptive exam logic
  isAdaptive  Boolean      @default(false)
  questionCount Int        @default(10)
  difficultyMin Int        @default(1)
  difficultyMax Int        @default(5)
  createdAt   DateTime     @default(now())

  createdById String
  createdBy   User         @relation("UserExams", fields: [createdById], references: [id])
  attempts    ExamAttempt[]
  assignments ExamAssignment[]

  @@index([subjectId])
  @@index([createdById])
}

model ExamAttempt {
  /// Primary identifier for each exam run
  id           String        @id @default(cuid())
  startedAt    DateTime      @default(now())
  finishedAt   DateTime?
  thetaStart   Decimal       @db.Decimal(3, 2)
  thetaEnd     Decimal       @db.Decimal(3, 2)
  /// Score awarded for this attempt
  score        Int

  examId       String
  exam         Exam          @relation(fields: [examId], references: [id], onDelete: Cascade)

  userId       String
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  currentQuestionId String?
  currentQuestion   Question? @relation("CurrentQuestion", fields: [currentQuestionId], references: [id], onDelete: SetNull)

  answers      AttemptAnswer[]
  studentExam  StudentExam? @relation("AttemptStudentExam")
}

model AttemptAnswer {
  /// Primary identifier for per-question response tracking
  id           String   @id @default(cuid())
  /// Whether the choice was correct
  isCorrect    Boolean
  thetaBefore  Decimal  @db.Decimal(3, 2)
  thetaAfter   Decimal  @db.Decimal(3, 2)
  pickedAt     DateTime @default(now())

  attemptId    String
  attempt      ExamAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)

  questionId   String
  question     Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  choiceId     String
  choice       Choice   @relation(fields: [choiceId], references: [id], onDelete: Cascade)
}

model Subject {
  id          String       @id @default(cuid())
  code        String       @unique
  name        String
  level       SubjectLevel @default(UNSPECIFIED)
  createdById String
  createdBy   User         @relation("TeacherSubjects", fields: [createdById], references: [id])
  exams       Exam[]
  enrollments SubjectEnrollment[]
  assignments ExamAssignment[]
  createdAt   DateTime     @default(now())

  @@index([createdById])
}

model SubjectEnrollment {
  id        String   @id @default(cuid())
  subjectId String
  userId    String
  subject   Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  student   User     @relation("StudentEnrollments", fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([subjectId, userId])
  @@index([userId])
}

model ExamAssignment {
  id         String   @id @default(cuid())
  examId     String
  subjectId  String
  assignedBy String
  startAt    DateTime @default(now())
  dueAt      DateTime?
  createdAt  DateTime @default(now())

  exam    Exam    @relation(fields: [examId], references: [id], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacher User    @relation("AssignmentTeacher", fields: [assignedBy], references: [id], onDelete: Cascade)

  studentLinks StudentExam[]

  @@index([subjectId])
  @@index([examId])
}

model StudentExam {
  id           String            @id @default(cuid())
  assignmentId String
  studentId    String
  status       StudentExamStatus @default(ASSIGNED)
  attemptId    String?          @unique
  assignedAt   DateTime          @default(now())
  completedAt  DateTime?

  assignment ExamAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student    User           @relation("StudentAssignments", fields: [studentId], references: [id], onDelete: Cascade)
  attempt    ExamAttempt?   @relation("AttemptStudentExam", fields: [attemptId], references: [id], onDelete: SetNull)

  @@unique([assignmentId, studentId])
  @@index([studentId])
}
